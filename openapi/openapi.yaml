openapi: 3.0.0
# Tool tip: https://editor.swagger.io/ (online)
info:
  title: Zenitel Link interface
  description: |
    **Zenitel Link** is composed of two different interfaces:
    1. REST interface for requesting information, and initiating call or device operations.
    2. WAMP (wamp-proto.org) interface that offer the same, but also event subscription to system events in addition.

    Most of the REST operations will result in one or more system events through the WAMP interface.
    There are events published at changes in call progress, call queue changes, door opened etc.
    Please see section **Events** and **Trace** buttons below for event defintions.
    It is possible to poll information using the REST interface, but it is way more efficient to subscribe to the WAMP events.
    The REST interface is a wrapper for the WAMP interface, hence, every REST operation has a WAMP counterpart which can be used directly.

    **How to Use:**

    Use the **'Authorize'** button, under **oAuth2Password (OAuth2, password)**
    type username as **client_id**, password as **client_secret** and click Authorize

  version: 1.2.0

paths:
  #
  #  Non-WAMP System RPCs
  #
  /api/auth/login:
    post:
      description: "Login and get a JWT token which is needed to access other pages.
                    In order to login and start using Zenitel Link, the external application
                    first needs to send a login request using this URI.
                    The username and password are encrypted as Base64 using standard HTTP Basic Access Authentication (Authorization: Basic xxxxx).
                    Upon successful login, the encrypted string 'access_token' is returned, and this must then be included
                    in the HTTP header as 'Authorization: Bearer xxxx' token for all other following requests."

      tags: ["Authentication"]
      security:
        - basicAuth: []
      responses:
        "401":
          $ref: '#/components/responses/unauthorized_error401'
        "200":
          description: "Provided correct username/password, JWT token is returned"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/credentials'

  /api/auth/refresh:
    post:
      tags: ["Authentication"]
      description: "Refresh JWT tokens and return new access JWT token and refresh JWT token."
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                refresh_token:
                  description: "Valid refresh token!"
                  example: Valid refresh JWT token
                  type: string
              required:
                - refresh_token
      responses:
        "401":
          $ref: '#/components/responses/unauthorized_error401'
        "200":
          description: "Provided correct refresh JWT token"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/credentials'

  /api/auth/logout:
    post:
      tags: ["Authentication"]
      description: "Performs logout on current user, invalidates JWT before expiry."
      security:
        - bearerAuth: []
      responses:
        "200":
          description: "User has been logged out, and user token will now be invalid. New login required for access"
        "401":
          $ref: '#/components/responses/unauthorized_error401'

  #
  #  WAMP System RPCs
  #
  /api/system/device_accounts:
    get:
      summary: "wamp URI : com.zenitel.system.device_accounts"
      tags: ["System"]
      description: "List of managed devices with states. Query filters may be used to get a selection of devices."
      parameters:
        - in: query
          name: state
          description: |
                    Filter on state of managed devices.
                    - Provisioned means all managed devices (default without filter argument).
                    - Registered means the device is or has been SIP registered.
                    - Reachable means the device is SIP registered and a valid endpoint.
                    - Unreachable means the device is offline or lost contact with the server.
                    - Unknown could be that the device is added as a managed device, but is still not registered to the server, or some other reason.
                    - wamp_status: Offline means the device has lost contact with the server or device is not native device.
                    - wamp_status: Online means the device is WAMP-registered and device is native device.
          required: false
          schema:
            $ref: '#/components/schemas/device_account_filter'
      responses:
        "200":
          description: "Successfully listed devices"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/device_account_state'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'


  /api/system/info/net_interfaces:
    get:
      summary: "wamp URI: com.zenitel.system.info.net_interfaces"
      tags: ["System"]
      description: "Return list of external network interfaces with addresses"
      responses:
        "200":
          description: "Success: Return JSON from command \"ip --json address\""
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    ifname:
                      type: string
                      example: eth0
                    ifindex:
                      type: integer
                      example: 2
                    address:
                      $ref: '#/components/schemas/mac_address'
                    addr_info:
                      type: array
                      items:
                        type: object
                        properties:
                          local:
                            type: string
                            example: "10.5.217.15"
                            description: "IP address"
                          family:
                            type: string
                            example: "inet"
                            enum: ["inet", "inet6"]
                          prefixlen:
                            type: integer
                            example: "28"
                          scope:
                            type: string
                            example: "global"
                            enum: ["global", "link"]
        "401":
          $ref: '#/components/responses/unauthorized_error401'

  /api/devices/device;{device_id}/gpos/gpo;{gpo_id}:
    post:
      summary: "wamp URI: com.zenitel.devices.device.gpos.gpo.post"
      tags: ["Device"]
      description: |
                    Change a single digital output controlled by a device. The gpo_id is made up of the type and the index starting from 1.
                    The index correspond to the array index in the device GPIO configuration, i.e the 'outputs' (relay) and 'gpio' arrays.
                    The number of outputs for each type may vary between device types.
                    In order to set a GPIO by this URI, the corresponding GPIO has to be configured as output.
                    Example: id=relay2, id=gpio5.
      parameters:
        - in: path
          name: device_id
          description: 'This path segment may be either dirno or mac_address, f.ex dirno=2341 or mac_address=02:ac:42:ef:27:ed'
          required: true
          schema:
            $ref: '#/components/schemas/device_id'
        - in: path
          name: gpo_id
          required: true
          schema:
            $ref: '#/components/schemas/gpo_id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/gpo_config'
      responses:
        "200":
          description: "Successfully changed GPO status."
        "404":
          $ref: '#/components/responses/application_error404'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'


  /api/devices/device;{device_id}/gpos:
    get:
      summary: "wamp URI: com.zenitel.devices.device.gpos"
      tags: ["Device"]
      description: "Get all or some General-Purpose Output (GPO), i.e relay / gpio / e_relay controlled by a device."
      parameters:
        - in: path
          name: device_id
          description: 'This path segment may be either dirno or mac_address, f.ex dirno=2341 or mac_address=02:ac:42:ef:27:ed'
          required: true
          schema:
            $ref: '#/components/schemas/device_id'
        - in: query
          name: id
          required: false
          schema:
            $ref: '#/components/schemas/gpio_filter'
      responses:
        "200":
          description: "Successfully read GPO status."
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/gpo'
        "404":
          $ref: '#/components/responses/application_error404'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'

  /api/devices/device;{device_id}/gpis:
    get:
      summary: "wamp URI: com.zenitel.devices.device.gpis"
      tags: ["Device"]
      description: "Get status of all or some General-Purpose Input (GPI) signals controlled by a device."
      parameters:
        - in: path
          name: device_id
          description: 'This path segment may be either dirno or mac_address, f.ex dirno=2341 or mac_address=02:ac:42:ef:27:ed'
          required: true
          schema:
            $ref: '#/components/schemas/device_id'
        - in: query
          name: id
          required: false
          schema:
            $ref: '#/components/schemas/gpio_filter'
      responses:
        "200":
          description: "Successfully read GPI status."
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/gpi'
        "404":
          $ref: '#/components/responses/application_error404'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'

  /api/devices/device;{device_id}/key:
    post:
      summary: "wamp URI: com.zenitel.devices.device.key.post"
      tags: ["Device"]
      description: "Does simulate key press on the device."
      parameters:
        - in: path
          name: device_id
          description: 'This path segment may be either dirno or mac_address, f.ex dirno=2341 or mac_address=02:ac:42:ef:27:ed'
          required: true
          schema:
            $ref: '#/components/schemas/device_id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/key'
        description: "<b>Note:</b><br>
                      * on, off is only relevant for save-autoanswer <br>
                      * save-autoanswer does not use press, tap and release <br>
                      * set id: m, c , p1..p2, digits [0-9], save_autoanswer. (p1 correspondes to dak0)"
      responses:
        "200":
          description: "Successfully changed key status."
        "404":
          $ref: '#/components/responses/application_error404'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'

  /api/calls:
    post:
      summary: "wamp URI: com.zenitel.calls.post"
      tags: ["Call Handling"]
      description: >
        Setup a call from the originating SIP endpoint to a destination endpoint. The progress of the call
        may be followed by subscribing to 'com.zenitel.calls' event topic. The RPC waits for the call
        to progress to one of the states 'queued', 'ringing', 'in_call' or 'ended', and responds with
        the current call state record.


        The priority parameter is only applicable for direct calls and will be ignored for broadcasts,
        calls to call queues and other call types where the priority is configured specifically for the particular function.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                from_dirno:
                  description: "Originating SIP endpoint. Must be an internal account or audio message."
                  example: "101"
                  type: string
                to_dirno:
                  description: "Destination SIP endpoint or feature"
                  example: "102"
                  type: string
                action:
                  description: "Action to be performed, defaults to call setup if omitted"
                  enum: [setup, answer]
                  example: "setup"
                  type: string
                verbose:
                  description: "If true, call_leg information is nested into the response"
                  type: boolean
                priority:
                  description: "Priority of call from 1 (High) to 250 (Low), default 40.
                                An urgent (21) call and higher will be connected in Open (Auto-answer) mode,
                                a normal (41) call will be annunciated depending on the setting of the receiving station."
                  example: 40
                  type: integer
      responses:
        "200":
          $ref: '#/components/responses/post_call'
        "201":
          $ref: '#/components/responses/post_call'
        "403":
          $ref: '#/components/responses/application_error403'
        "404":
          $ref: '#/components/responses/application_error404'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'
        "409":
          description: "Attempt to answer to busy to_dirno"
        "500":
          description: "Server error, time out waiting for call to reach desired state"
    get:
      summary: "wamp URI: com.zenitel.calls"
      tags: ["Call Handling"]
      description: "Get active calls and states. Without arguments, all active calls are returned.
                    Query paramters may be used to limit the selection. If multiple query parameters are
                    provided, they are logically ANDed together which limits the selection further."
      parameters:
        - in: query
          name: from_dirno
          description: "Optional dirno filter to limit selection"
          required: false
          schema:
            $ref: '#/components/schemas/dirno_filter'
        - in: query
          name: to_dirno
          description: "Optional dirno filter to limit selection"
          required: false
          schema:
            $ref: '#/components/schemas/dirno_filter'
        - in: query
          name: call_id
          description: "Optional call identifier filter to limit selection"
          required: false
          schema:
            $ref: '#/components/schemas/call_id_filter'
        - in: query
          name: state
          description: "Optional state filter to limit selection"
          required: false
          schema:
            $ref: '#/components/schemas/call_state_filter'
        - in: query
          name: verbose
          required: false
          description: "If true, call_leg information is nested into the response"
          schema:
            type: boolean

      responses:
        "200":
          description: "Success returning list of calls"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/call_rich'
        "404":
          $ref: '#/components/responses/application_error404'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'

    delete:
      summary: "wamp URI: com.zenitel.calls.delete"
      tags: ["Call Handling"]
      description: "Hang up all calls where supplied dirno is active. Note that if the supplied dirno argument contains
                    a dirno with no active calls, the response will still be 200 OK, but with an empty array in the response body.
                    The progress of the affected calls may be followed by subscribing to 'com.zenitel.calls' event topic"
      parameters:
        - in: query
          name: dirno
          description: "Hang up all calls matching this SIP endpoint.
                        Special case : dirno=alldirno will hang up all calls"
          required: true
          schema:
            $ref: '#/components/schemas/dirno_filter'
      responses:
        "200":
          description: "Successfully hungup call(s)"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/deleted_calls'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'
        "500":
          description: "Server error, time out waiting for call to end"

  /api/call_legs:
    get:
      summary: "wamp URI: com.zenitel.call_legs"
      tags: [Call Handling]
      description: "Get active call_legs and states. A call_leg is a component of a call. Normally there are
                    two call legs for a normal call from one device to another; one for the caller and one for the
                    calleee. But for queue calls or group calls, there could be many call legs for one call.
                    Without arguments, all active call legs are returned.
                    Query paramters may be used to limit the selection. If multiple query parameters are
                    provided, they are logically ANDed together which limits the selection further."
      parameters:
        - in: query
          name: from_dirno
          description: "Optional from dirno filter to limit selection"
          required: false
          schema:
            $ref: '#/components/schemas/dirno_filter'
        - in: query
          name: to_dirno
          description: "Optional to dirno filter to limit selection"
          required: false
          schema:
            $ref: '#/components/schemas/dirno_filter'
        - in: query
          name: dirno
          description: "Optional filter on 'owner' of call leg. For a queue call for example,
                        dirno could be the operator dirno, from_dirno is the caller and to_dirno is the queue dirno."
          required: false
          schema:
            $ref: '#/components/schemas/dirno_filter'
        - in: query
          name: leg_id
          description: "Optional call leg identifier for one specific call leg."
          required: false
          schema:
            $ref: '#/components/schemas/leg_id_filter'
        - in: query
          name: call_id
          description: "Optional call id identifier filter to limit selection."
          required: false
          schema:
            $ref: '#/components/schemas/call_id_filter'
        - in: query
          name: state
          description: "Optional state filter to limit selection"
          required: false
          schema:
            $ref: '#/components/schemas/leg_state_filter'
        - in: query
          name: leg_role
          required: false
          description: "Optional leg role filter to limit selection"
          schema:
            $ref: '#/components/schemas/leg_role'
      responses:
        "200":
          description: "Success returning list of call legs"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/call_leg'
        "404":
          $ref: '#/components/responses/application_error404'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'

  /api/calls/call;{call_id}:
    delete:
      summary: "wamp URI : com.zenitel.calls.call.delete"
      tags: ["Call Handling"]
      description: "Hang up a specified call. The progress of the affected call
                    may be followed by subscribing to 'com.zenitel.call' event topic"
      parameters:
        - in: path
          name: call_id
          description: "Hang up the specified call using the call_id."
          required: true
          schema:
            $ref: '#/components/schemas/call_id_path'
      responses:
        "200":
          description: "Successfully hungup call"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/deleted_calls'
        "404":
          $ref: '#/components/responses/application_error404'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'

  /api/call_queues:
    get:
      summary: "wamp URI: com.zenitel.call_queues"
      tags: ["Call Handling"]
      description: "Get a list of all call queues with queued calls. Without argument, all call queues are returned.
                    A single queue is returned if queue_dirno parameter is specified."
      parameters:
        - in: query
          name: queue_dirno
          description: "Optional query parameter to filter on queue directory number"
          required: false
          schema:
            type: string

      responses:
        "200":
          description: "Success return list of queue calls"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/call_queue'
        "404":
          $ref: '#/components/responses/application_error404'
        "400":
          $ref: '#/components/responses/application_error400'
        "401":
          $ref: '#/components/responses/unauthorized_error401'

  /api/calls/call/open_door:
    post:
      summary: "wamp URI: com.zenitel.calls.call.open_door.post"
      tags: ["Call Handling"]
      description: "Open a door in a call. If valid: com.zenitel.system.open_door event is published. Depending on configuration also set GPO on door device using a RPC."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                from_dirno:
                  description: "Directory number of operator in a call with the door"
                  example: "101"
                  type: string
      responses:
        "200":
          description: "Successfully sent an open door rpc to the device"
        "403":
          description: "Permission denied to open the door"
        "404":
          description: "Device is not in call or has no door assigned"

  /files/upload/audio_message/{filename}:
    put:
      summary: Upload a file to Zenitel Connect Pro.
      tags: ["System"]
      description: "Upload a file to Zenitel Connect Pro. File size is maximum 20MByte but may be further restricted by the available storage space in Zenitel Connect Pro."
      parameters:
        - name: filename
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          audio/wav:  # For .wav .wav16
            schema:
              type: string
              format: binary
          audio/opus:
            schema:
              type: string
              format: binary
          audio/flac:
            schema:
              type: string
              format: binary
          audio/webm:
            schema:
              type: string
              format: binary
          audio/weba:
            schema:
              type: string
              format: binary
          audio/ogg:  # for .ogg and .oga
            schema:
              type: string
              format: binary
          audio/x-m4a:  # Commonly used MIME type for .m4a
            schema:
              type: string
              format: binary
          audio/midi:   # Common MIME type for .mid .midi .kar
            schema:
              type: string
              format: binary
          audio/mpeg:   # For .mp3
            schema:
              type: string
              format: binary
          audio/aiff:   # For .aiff .aif
            schema:
              type: string
              format: binary
          audio/x-ms-wma:   # Commonly used MIME type for .wma
            schema:
              type: string
              format: binary
          audio/basic:  # For .au .snd
            schema:
              type: string
              format: binary
        description: A list of supported audio file formats.

      responses:
        '201':
          description: "File uploaded successfully"
        '204':
          description: "File already exists"
        '400':
          description: "Invalid file or path or Content-Type"
        '401':
          description: "Error: Unauthorized"
        '403':
          $ref: '#/components/responses/application_error403'
        '413':
          description: "Error: Request Entity Too Large"

  /api/system/audio_messages:
    post:
      summary: "wamp URI: com.zenitel.system.audio_messages.post"
      tags: ["System"]
      description: >
                  Import an uploaded audio file to an audio_message. Convert to internal
                  format, update the audio_message table. `displayname` and `repetitions`
                  are optional parameters. `repetitions` is JSON null (continuous) or a positive
                  number. If `repetitions` is missed or a negative number, the default value (1)
                  will be used.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                filename:
                  description: "Orignal filename of file uploaded to /files/upload"
                  example: 'test.wav'
                  type: string
                dirno:
                  description: "Directory number of audio_messages"
                  example: '700'
                  type: string
                displayname:
                  type: string
                  description: "Display name if you dial the message. It will be the dirno if this parameter is empty."
                  example: "Fire Alarm"
                  nullable: true
                repetitions:
                  description: "Number of times the message is played, default 1. null means continous."
                  example: 1
                  type: integer
                  nullable: true
      responses:
        "200":
          description: "File imported to audio_message"
        "400":
          description: "Missing file, filename or dirno argument"
    get:
      summary: "wamp URI: com.zenitel.system.audio_messages"
      tags: ["System"]
      description: "Get a list of uploaded audio_messages"
      responses:
        "200":
          description: "List of audio messages"
          content:
            application/json:
              schema:
                type: object
                properties:
                  audio_messages:
                    type: array
                    description: "Returns list of the audio messages."
                    items:
                      type: object
                      properties:
                        dirno:
                          type: string
                          description: "Directory number of audio message"
                          example: "9001"
                        filename:
                          type: string
                          description: "Filename of audio message"
                          example: "test.wav"
                        filepath:
                          type: string
                          description: "HTTP path of audio message for GET"
                          example: "/files/audio/messages/test.wav"
                        filesize:
                          type: integer
                          description: "File size of stored message in bytes"
                          example: 200000
                        duration:
                          type: integer
                          description: "Duration of voice message in seconds"
                          example: 30
                  used_space:
                    type: integer
                    description: "Total space used on system for stored messages in bytes"
                    example: 200000
                  available_space:
                    type: integer
                    description: "Available space on system for stored messages in bytes"
                    example: 20000000

  /api/groups:
    get:
      summary: "wamp URI: com.zenitel.groups"
      tags: ["System"]
      description: "Get list of configured device groups (group calls)"
      parameters:
        - in: query
          name: dirno
          description: "Optional query parameter to filter on specific group (call)"
          required: false
          schema:
            type: string
        - in: query
          name: verbose
          required: false
          description: "If true, group members are also included in the response"
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: "List of audio messages"
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    dirno:
                      type: string
                      description: "Directory number of group call"
                      example: "84"
                    displayname:
                      type: string
                      description: "Displayname number of group call"
                      example: "All call"
                    priority:
                      $ref: '#/components/schemas/call_priority'
                    call_timeout:
                      type: integer
                      description: "Max duration for call"
                      example: 3600
                    members:
                      type: array
                      description: "Directory numbers of group members, only included if verbose=true"
                      items:
                        type: string
                        description: "Directory number of group call member"
                        example: "101"

  /api/directory:
    get:
      summary: "wamp URI: com.zenitel.directory"
      tags: ["System"]
      description: "Get list of configured directory numbers"
      parameters:
        - in: query
          name: dirno
          description: "Optional query parameter to filter on specific directory number"
          required: false
          schema:
            type: string
      responses:
        "200":
          description: "List of directory numbers"
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    dirno:
                      type: string
                      description: "Directory number"
                      example: "101"
                    displayname:
                      type: string
                      description: "Display name of directory number"
                      example: "Control room"
                    feature_type:
                      type: string
                      enum: ["device_call", "queue_call", "trunk_prefix", "group_call", "message_call"]
                      description: "Feature type of directory number"
                      example: "device_call"

  /api/call_forwarding:
    get:
      summary: "wamp URI: com.zenitel.call_forwarding"
      tags: ["System"]
      description: "Returns list of current call forwarding rules"
      parameters:
        - in: query
          name: dirno
          description: "If provided, only return call forwarding rules owned by this directory number."
          required: false
          schema:
            type: string
            example: "101"
        - in: query
          name: fwd_type
          description: "If provided, only return call forwarding rules of this type"
          required: false
          schema:
            $ref: "#/components/schemas/fwd_type"
      responses:
        "200":
          description: "Current call forwarding status"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/call_forward_list"
        "400":
          description: "Invalid request parameters"
    post:
      summary: "wamp URI: com.zenitel.call_forwarding.post"
      tags: ["System"]
      description: |
        Add or update a number of call forwarding rules. Input is an array of
        call forwarding rule objects. Key fields for a call forwarding rule are
        "dirno" and "fwd_type". Both must be present in the forwarding objects.

        If "dirno" and "fwd_type" do not match existing entry, the rule is added.

        Otherwise existing entry is updated. On update, only the fields included
        in the request object are updated. Fields *not* included in the request
        object are preserved.

        The request return 200 OK if top level input is an array of objects.
        Check "error_cnt" and "errors" list in response for actual results for
        the operations.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/call_forward_list"
      responses:
        "200":
          description: "Top level post structure accepted. \"error_cnt \"say how many input entries failed"
          content:
            application/json:
              schema:
                type: object
                properties:
                  error_cnt:
                    type: integer
                    description: "Number of rule update that failed"
                    example: 0
                  update_cnt:
                    type: integer
                    description: "Number of added or updated entries"
                    example: 1
                  errors:
                    type: array
                    description: "Array, one item for each input object"
                    items:
                      type: string
                      nullable: true
                      description: "Error message. JSON null mean no error"
                      example: null
        "400":
          description: "Invalid request parameters"
    delete:
      summary: "wamp URI: com.zenitel.call_forwarding.delete"
      tags: ["System"]
      description: "Delete call forwarding settings of specified directory number, forwarding type"
      parameters:
        - in: query
          name: dirno
          description: "Delete call forwarding rules owned by this directory number. Use \"alldirno\" to match all"
          required: true
          schema:
            type: string
            example: "101"
        - in: query
          name: fwd_type
          description: "Delete call forwarding rules of this type. Use \"all\" to match all"
          required: true
          schema:
            type: string
            enum: [unconditional, on_timeout, on_busy, all]

      responses:
        "200":
          description: "Parameters accepted. \"delete_cnt \"say how many entries was deleted "
          content:
            application/json:
              schema:
                type: object
                properties:
                  delete_cnt:
                    type: integer
                    description: "Number of deleted entries"
                    example: 1
        "400":
          description: "Invalid request parameters"

  #
  #  WAMP Events
  #
  com.zenitel.call:
    trace:
      summary: "WAMP subscribe to call events"
      tags: ["Events"]
      description: "Subscribe to call events. Whenever a call is initiated, progress or hangup, an event will be published on this channel.
                    This is <b>only</b> used for documenting wamp subscribe, HTTP GET to this URL does nothing."
      responses:
        "Event":
          description: "A call event occurred"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/call_basic'

  com.zenitel.call_leg:
    trace:
      summary: "WAMP subscribe to call leg events"
      tags: ["Events"]
      description: "Subscribe to call leg events. Whenever a call leg is initiated or updated, an event will be published
                    on this channel.
                    This is <b>only</b> used for documenting wamp subscribe, HTTP GET to this URL does nothing."
      responses:
        "Event":
          description: "A call event occurred"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/call_leg'

  com.zenitel.system.event_trigger:
    trace:
      summary: "WAMP subscribe to event trigger"
      tags: ["Events"]
      description: "Subscribe to event trigger.
                   Whenever a call to event trigger with directory number in directory services table, the event trigger is initiated, progressed, and be published on this channel.
                   This is <b>only</b> used for documenting wamp subscribe, HTTP GET to this URL does nothing."
      responses:
        "Event":
          description: "An event trigger occurred"
          content:
            application/json:
              schema:
                type: object
                properties:
                  from_dirno:
                    type: string
                    example: "1001"
                    description: "Source directory number"
                  to_dirno:
                    type: string
                    example: "7900"
                    description: "Destination directory number"
                required:
                  - from_dirno
                  - to_dirno

  com.zenitel.device.gpo:
    trace:
      summary: "Subscribe to device gpo's"
      tags: ["Events"]
      description: "Subscribe on gpo/relay changes.
                    This is <b>only</b> used for documenting wamp subscribe, HTTP GET to this URL does nothing."
      responses:
        "Event":
          description: "A gpo/relay change happened"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/gpo'

  com.zenitel.device.gpi:
    trace:
      summary: "Subscribe to device gpi's"
      tags: ["Events"]
      description: "Subscribe on gpi/gpio changes. This is <b>only</b> used for documenting wamp subscribe, HTTP GET to this URL does nothing."
      responses:
        "Event":
          description: "A change in gpi/gpoi was made"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/gpi'

  com.zenitel.system.device_account:
    trace:
      summary: "Subscribe to state change of devices"
      tags: ["Events"]
      description: "Subscribe to device state changes. This is <b>only</b> used for documenting wamp subscribe, HTTP GET to this URL does nothing."
      responses:
        "Event":
          description: "A new device was added or change in SIP registration."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/device_account_state'

  com.zenitel.system.open_door:
    trace:
      summary: "WAMP subscribe to open door events"
      tags: ["Events"]
      description: "Dialing digit 6 in conversation will trigger an open door event. This is <b>only</b> used for documenting wamp subscribe, HTTP GET to this URL does nothing."
      responses:
        "Event":
          description: "A call event occurred"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/open_door'


  com.zenitel.wamp.session.on_join:
    trace:
      summary: "Subscribe to WAMP session start event"
      tags: ["Events"]
      description: "Subscribe WAMP connection start event. The event is similar to
        https://wamp-proto.org/_static/gen/wamp_latest.html#x14-5-1-2-session-meta-events,
        except that the data is placed in 'arglist[0]', not in 'details'.
        This is <b>only</b> used for documenting wamp subscribe, HTTP GET to this URL does nothing."
      responses:
        "Event":
          description: "A subscriber joined the session"
          content:
            application/json:
              schema:
                type: object
                properties:
                  session:
                    description: "WAMP session ID"
                    example: "3"
                    type: integer
                  authid:
                    description: "WAMP user name of session"
                    example: "device@0013cb012345"
                    type: string
                  authrole:
                    description: "WAMP authorization role"
                    example: "device"
                    type: string

  com.zenitel.wamp.session.on_leave:
    trace:
      summary: "Subscribe to WAMP session close event"
      tags: ["Events"]
      description: "Subscribe WAMP connection close event. This is <b>only</b> used for documenting wamp subscribe, HTTP GET to this URL does nothing."
      responses:
        "Event":
          description: "A subscriber left the session"
          content:
            application/json:
              schema:
                type: object
                properties:
                  session:
                    description: "WAMP session ID"
                    example: "3"
                    type: integer
                  authid:
                    description: "WAMP user name of session"
                    example: "device@0013cb012345"
                    type: string
                  authrole:
                    description: "WAMP authorization role"
                    example: "device"
                    type: string
  com.zenitel.system.device.extended_status:
    trace:
      summary: "Subscribe to WAMP session to publish test results for tone and button tests"
      tags: ["Events"]
      description: "Subscribe to WAMP to publish est results for tone and button tests. This is <b>only</b> used for documenting wamp subscribe, HTTP GET to this URL does nothing."
      responses:
        "Event":
          description: "Publish test results for tone and button tests"
          content:
            application/json:
              schema:
                type: object
                properties:
                  current_status:
                    description: "Tone test result"
                    example: "passed"
                    type: string
                    enum: [passed, failed, busy]
                  device_id:
                    description: "Device id"
                    example: "4"
                    type: int
                  dirno:
                    description: "Device dirno"
                    example: "103"
                    type: string
                  error_message:
                    description: "Error message"
                    example: "Test PASSED, silence: -91 tone: -130"
                    type: string
                  last_fail:
                    description: "Last fail time"
                    example: "2024-10-29T15:12:30.717033+00:00"
                    type: timestamptz
                  last_pass:
                    description: "Last pass time"
                    example: "2024-10-29T15:12:23.70557+00:00"
                    type: timestamptz
                  last_queued:
                    description: "Last queued time"
                    example: "2024-10-29T15:12:22.062465+00:00"
                    type: timestamptz
                  pending_test:
                    description: "Pending test(true or false)"
                    example: "false"
                    type: boolean
                  status_type:
                    description: "status type(tonetest or buttontest)"
                    example: "tonetest"
                    type: string
                    enum: [tonetest, buttontest]
  /api/system/devices/test/tone:
    post:
      summary: "wamp URI : com.zenitel.system.devices.test.tone.post"
      tags: ["Tone test"]
      description: "Start Tone test for Dirno."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                dirno:
                  description: "Directory number of tone test"
                  example: '700'
                  type: string
              required: [dirno]
      responses:
        "202":
          description: "Tone test for Dirno started. Zero pending devices means no devices to test, a non-zero count means a test is in progress."
        "200":
          description: "The tone test was not performed. This could be due to devices being offline or missing, or because a test is already running."

  /api/system/devices/test/button:
    post:
      summary: "wamp URI : com.zenitel.system.devices.test.button.post"
      tags: ["Button test"]
      description: "Start button test for Dirno."
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                dirno:
                  description: "Directory number of button test"
                  example: '700'
                  type: string
      responses:
        "202":
          description: "Button test for Dirno started. Zero pending devices means no devices to test, a non-zero count means a test is in progress."
        "200":
          description: "The Button test was not performed. This could be due to devices being offline or missing, or because a test is already running."

security:
  - oAuth2Password: []
  - bearerAuth: []

#
# Table of tags
#
tags:
  - name: Authentication
  - name: System
  - name: Call Handling
  - name: Device
  - name: Events
    description: For subscription to WAMP topics

#
#  Schemea Components
#
components:
  securitySchemes:
    oAuth2Password:
      type: oauth2
      description: Type username as client_id, password as client_secret
      flows:
        password:
          tokenUrl: /api/auth/login
          refreshUrl: /api/auth/refresh
          scopes: {}
    basicAuth:
      type: http
      scheme: basic
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    mac_address:
      type: string
      description: "MAC address, lower case hex with colons.
                    Could be a random MAC address (locally administered ranges)"
      example: '00:13:cb:00:55:55'
      pattern: '[0-9a-f:]{12,20}'
      minLength: 12
      maxLength: 20

    device_id:
      example: 'dirno=101'
      oneOf:
        - type: string
          pattern: '^dirno=[\d]+$'
        - type: string
          pattern: '^mac_address=[0-9a-f:]{12,20}$'

    gpo_id:
      type: string
      description: "Identity of the output to control. The values depend on hardware support. Examples are: relay1, relay2, gpio1"
      example: "id=relay1"
      pattern: '^id=[\w]+$'

    device_account_filter:
      type: string
      enum: ["provisioned", "registered", "reachable", "unreachable", "unknown"]
      example: "provisioned"

    gpio_filter:
      type: string
      description: "Query single output or input. Examples: relay1, relay2, gpio1, gpi2."
      example: "relay1"
      pattern: '^[\w]+$'

    dirno_filter:
      type: string
      # for some reason, swagger does not understand the 'required=false'
      # for query and automatically inserts dirno as value which then fails
      # the pattern test with [\d] which it should have been.
      # Leave it for now, but dirno should be digits only. Also tried with integer...
      example: '101'
      pattern: '^[\w]+$'

    call_id_path:
      type: string
      description: "URI path segment parameter for unique ID of a call"
      example: "call_id=12345"
      # current swagger version does not allow empty integer fields, that is why there is both integer and string version
    call_id_filter:
      type: string
      description: "Unique ID filter of a call"
      example: "12345"

    call_id:
      type: integer
      description: "Unique ID of a call"
      example: 12345

    leg_id:
      type: integer
      description: "Unique ID of call leg"
      example: 56789

    leg_id_filter:
      type: string
      description: "Unique ID filter of call leg"
      example: "56789"

    call_state:
      type: string
      description: "State of call"
      enum: ["init", "forwarding", "queued", "ringing", "in_call", "ended"]
      example: "ringing"

    call_state_filter:
      type: string
      description: "Filter on state of call"
      enum: ["queued", "ringing", "in_call"]              # non transient states
      example: "in_call"

    leg_state:
      type: string
      description: "State of call leg"
      enum: ["init", "waiting", "forwarding", "queued", "ringing", "in_call", "ended"]
      example: "ringing"

    leg_state_filter:
      type: string
      description: "State of call leg"
      enum: ["waiting", "queued", "ringing", "in_call"]              # non transient states
      example: "in_call"

    leg_role:
      type: string
      description: "Call leg role"
      enum: ["caller", "callee"]
      example: "caller"

    call_reason:
      type: string
      description: "The reason for last change of the call / call-leg state)"
      enum: ["incoming", "rpc", "busy", "unreachable", "incomplete", "timeout", "progress", "unconditional", "from_ring", "accept",
             "other_answer", "auto-answer", "cancel", "reject", "success", "failure", "priority", "server_hangup", "hangup"]
      example: "accept"

    call_type:
      type: string
      description: "The type of call. Supported as of now is normal two party call and queue call."
      enum: ["normal_call", "queue_call", "group_call", "message_play", "activation_call"]

    call_priority:
      type: integer
      description: "Priority of the call 1 - 250, 1 is highest priority"
      maximum: 250
      minimum: 1
      example: 100

    call_basic:
      type: object
      properties:
        call_id:
          $ref: '#/components/schemas/call_id'
        state:
          $ref: '#/components/schemas/call_state'
        reason:
          $ref: '#/components/schemas/call_reason'
        call_type:
          $ref: '#/components/schemas/call_type'
        from_dirno:
          description: "Caller directory number"
          type: string
          example: "101"
        from_leg_id:
          allOf:
            - $ref: '#/components/schemas/leg_id'
            - description: "The caller leg identifier of the incoming caller"
        to_dirno:
          description: "Originally called directory number"
          type: string
          example: "102"
        to_dirno_current:
          description: "Currently called directory number. Initially same as to_dirno, but may be updated as call progresses due to queue call answer or call forwarding."
          type: string
          example: "102"
        groups:
          type: array
          description: "List of groups targeted by group call. Only present when call_type = group_call"
          items:
            type: string
            description: "Group call directory number"
            example: "84"
        priority:
          $ref: '#/components/schemas/call_priority'
        start_time:
          type: string
          description: "Timestamp when call was created, ISO 8601 format with timezone offset (decisecond precision)"
          example: "2022-11-01 10:14:24.1+00:00"
        queue_pos:
          type: integer
          description: "Number in queue on \"to_dirno_current\". 1 is first in queue. Reported when call is in \"init\", \"queued\" or \"ringing\" state.
                        If there is an established call (\"in_call\") at \"to_dirno_current\", that call is considered to have position 1,
                        so the queue starts at 2. A ringing call only have \"queue_pos\" 1 if the device is not in a established call.
                        If \"to_dirno_current\" is a call queue, queue always start at 1 because established calls are not part of the call queue."
          example: 1
      required: [id, state, reason, call_type, from_dirno, from_leg_id, to_dirno, priority, start_time]

    call_rich:
      allOf:
        - $ref: '#/components/schemas/call_basic'
        - type: object
          properties:
            call_legs:
              type: array
              description: "The active legs of the call. Caller leg first."
              items:
                $ref: '#/components/schemas/call_leg_no_inherit'
          required: [call_legs]

    call_leg_no_inherit:  # Properties of call leg not inherited from call
      type: object
      properties:
        leg_id:
          $ref: '#/components/schemas/leg_id'
        dirno:
          description: "The directory number of the call leg 'owner'. In case of a queue call,
                        this number could be the operator directory number, while 'from_dirno'
                        is caller and 'to_dirno' is the queue number called."
          type: string
          example: "101"
        state:
          allOf:
            - $ref: '#/components/schemas/leg_state'
            - description: "Current state of the leg"
        reason:
          allOf:
            - $ref: '#/components/schemas/call_reason'
            - description: "The reason for last change of the call leg state"
        leg_role:
          $ref: '#/components/schemas/leg_role'
        channel:
          description: "The internal channel identifier"
          type: string
          example: "PJSIP/101-0000002c;3"
          required: [call_legs]
        queue_pos:
          type: integer
          description: "Number in queue on \"dirno\". 1 is first in queue. Reported when call-leg is in \"init\", \"queued\" or \"ringing\" state.
                        If there is an established call (\"in_call\") at \"dirno\", that call is considered to have position 1,
                        so the queue starts at 2. A ringing call only have \"queue_pos\" 1 if the device is not in a established call."
          example: 1
      required: [id, dirno, state, reason, leg_role]

    call_leg:
      allOf:
        - $ref: '#/components/schemas/call_leg_no_inherit'
        - type: object
          properties:
            call_id:
              allOf:
                - $ref: '#/components/schemas/call_id'
                - description: "The parent call identifier"
            call_type:
              $ref: '#/components/schemas/call_type'
            from_dirno:
              description: "Caller directory number"
              type: string
              example: "101"
            to_dirno:
              description: "Recipient directory number"
              type: string
              example: "102"
            priority:
              $ref: '#/components/schemas/call_priority'
          required: [call_id, channel, call_type, from_dirno, to_dirno, priority]

    call_queue:
      type: object
      properties:
        queue_dirno:
          description: "The directory number of the call queue"
          type: string
          example: "701"
        calls:
          type: array
          description: "Calls queued in the call queue. Listed in order, first in queue first.
                        Accepted calls (state : in_call) are not included as they no
                        longer are considered part of the call queue."
          items:
            $ref: '#/components/schemas/call_rich'
        operators:
          type: array
          description: "Operators of the call queue"
          items:
            type: object
            properties:
              dirno:
                type: string
                description: "Directory number of operator"
                example: "112"
      required: [queue_dirno, calls, operators]

    deleted_calls:
      type: object
      description: Successful response from hangup call action.
      properties:
        call_id:
          $ref: '#/components/schemas/call_id'

    gpo_config:
      type: object
      properties:
        operation:
          description: "What to do with the relay"
          type: string
          enum: [set, clear, slow_blink, fast_blink, set_timed]
          example: "set"
        time:
          description: "If operation is set_timed, this is the duration in seconds beeing activated"
          type: integer
      required: [operation]

    gpo:
      type: object
      properties:
        dirno:
          description: "Directory number of operator"
          type: string
          example: "1001"
        gpios:
          description: "Bitmap for gpios"
          type: string
          example: "f--0--"
        id:
          description: "Identity of the GPO. The values depend on what the hardware supports and the device configuration. Examples: relay1, gpio1"
          type: string
          example: "gpio1"
        operation:
          description: "The state of the GPO"
          type: string
          enum: [high, low, slow_blink, fast_blink, timer]
          example: "fast_blink"
        relays:
          description: "The gpio pin on the device"
          type: string
          example: "0"
      required: [id, operation, relays]

    gpi:
      type: object
      properties:
        dirno:
          description: "Directory number of operator"
          type: string
          example: "1001"
        gpis:
          description: "Identity of the GPIs."
          type: string
          example: "100"
        id:
          description: "Identity of the GPI. The values depend on what the hardware supports and the device configuration."
          type: string
          example: "gpi3"
        state:
          description: "The state of the GPI"
          type: string
          enum: [active, inactive]
          example: "active"
      required: [id, state]


    key:
      type: object
      properties:
        id:
          description: "Name of the key/dak"
          type: string
          example: "p1"
          # Internal info: q (quit)
        edge:
          description: "Type of keypress"
          type: string
          enum: [press, tap, release, 'on', 'off']
          example: "press"
      required: [id, edge]

    device_account_state:
      type: object
      properties:
        dirno:
          type: string
          example: "101"
          description: "Directory number of device"
        name:
          type: string
          example: "Reception"
          description: "Name (display name) of the device"
        location:
          type: string
          example: "Main building"
          description: "Location of the device. May be empty if not defined."
        device_ip:
          type: string
          example: "192.15.34.2"
          description: "The IP address of the device. May be empty if the device is offline"
        device_type:
          type: string
          example: "TCIS-1"
          description: "The device type name"
        state:
          enum: ["reachable", "unreachable", "unknown"]
          type: string
          example: "reachable"
          description: "State of the device"
        wamp_status:
          enum: ["Online", "Offline"]
          type: string
          example: "Online"
      required: [dirno, name, location, state]


    credentials:
      type: object
      properties:
        access_token:
          type: string
          description: The access JWT token
        expires_in:
          type: integer
          description: "Expiration time for access JWT token in second."
          example: 300
        refresh_token:
          type: string
          description: The JWT token to use in the HTTP body as Authorization Bearer in other requests
        token_type:
          type: string
          description: "The token type which for now can only be Bearer"
          enum: [Bearer]

    fwd_type:
      type: string
      enum: [unconditional, on_timeout, on_busy]
      description: "Type of call forwarding"
      example: "unconditional"

    call_forward:
      type: object
      properties:
        dirno:
          type: string
          description: Owner of call forward rule, directory number
          example: "101"
        fwd_type:
          $ref: '#/components/schemas/fwd_type'
          description: "Type of call forwarding"
        fwd_to:
          type: string
          description: "Forward call to this number, directory number, external number"
          example: "300"
        enabled:
          type: boolean
          description: "Call forwarding only takes place if enabled is true"
          example: true

    call_forward_list:
      type: array
      items:
        $ref: '#/components/schemas/call_forward'

    # could have one common, but better examples improves the impressions
    error_reason400:
      type: object
      properties:
        error_reason:
          type: string
          description: "Detailed reason why the request could not be carried out."
          example: "Bad request, required arguments missing or invalid"

    error_reason403:
      type: object
      properties:
        error_reason:
          type: string
          description: "Detailed reason why the request could not be carried out."
          example: "Insufficient permissions to access resource"

    error_reason404:
      type: object
      properties:
        error_reason:
          type: string
          description: "Detailed reason why the request could not be carried out."
          example: "Device info for dirno = 107 was not found in the database"

    open_door:
      type: object
      properties:
        from_dirno:
          description: "Directory number of operator opening door"
          type: string
          example: "101"
        from_name:
          description: "Displayname of operator opening door"
          type: string
          example: "Operator"
        door_dirno:
          description: "Directory number of door"
          type: string
          example: "102"
        door_name:
          description: "Displayname of door"
          type: string
          example: "Door Station"
        gpo:
          description: "Present if a GPO is configured to open the door: GPO address, parameters"
          type: object
          properties:
            gpo_id:
              description: "Id of the gpo/gpio. The values depend on hardware support."
              example: "relay1"
            mac_address:
              $ref: '#/components/schemas/mac_address'
            time:
              description: "If operation is set_timed, this is the duration in seconds beeing activated"
              type: integer
              example: 3
      required: [from_dirno, from_name, to_dirno, door_name]

  responses:

    post_call:
      description: "Successful response from call action. 201 on call setup, 200 on call answer.
         call_legs only included if verbose=true."
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/call_rich'

    post_call_id:
      description: "Call action accepted, effect depends on call state"
      content:
        application/json:
          schema:
            type: object
            properties:
              call_id:
                $ref: '#/components/schemas/call_id'

    unauthorized_error401:
      description: Authentication information is missing or invalid
      headers:
        WWW_Authenticate:
          schema:
            type: string

    application_error400:
      description: "Request could not be carried out. Please see supplied error_reason for details."
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/error_reason400'

    application_error403:
      description: "Forbidden."
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/error_reason403'

    application_error404:
      description: "Resource not found. Please see supplied error_reason for details."
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/error_reason404'
